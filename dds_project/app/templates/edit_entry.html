{% extends "base.html" %}

{% block content %}
<h1>{% if entry %}Редактировать{% else %}Добавить{% endif %} запись</h1>

<form method="post">
    <div class="mb-3">
        <label class="form-label">Дата</label>
        <input type="date" name="date" value="{{ entry.date.isoformat() if entry else '' }}" class="form-control" required>
    </div>
    <div class="mb-3">
        <label class="form-label">Статус</label>
        <select name="status_id" class="form-select" required>
            {% for s in statuses %}
            <option value="{{ s.id }}" {% if entry and entry.status_id == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Тип</label>
        <select name="type_id" id="entry-type" class="form-select" required>
            {% for t in types %}
            <option value="{{ t.id }}" {% if entry and entry.type_id == t.id %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Категория</label>
        <select name="category_id" id="entry-category" class="form-select" required>
            {% for c in categories %}
            <option value="{{ c.id }}" {% if entry and entry.category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Подкатегория</label>
        <select name="subcategory_id" id="entry-subcategory" class="form-select" required>
            {% for s in subcategories %}
            <option value="{{ s.id }}" {% if entry and entry.subcategory_id == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Сумма</label>
        <input type="number" step="0.01" name="amount" value="{{ entry.amount if entry else '' }}" class="form-control" required>
    </div>
    <div class="mb-3">
        <label class="form-label">Комментарий</label>
        <textarea name="comment" class="form-control">{{ entry.comment if entry else '' }}</textarea>
    </div>
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a href="/" class="btn btn-secondary">Отмена</a>
</form>

<script>
document.getElementById('entry-type').addEventListener('change', async function() {
    const typeId = this.value;
    if (typeId) {
        const response = await fetch(`/api/categories/${typeId}`);
        const cats = await response.json();
        const catSelect = document.getElementById('entry-category');
        catSelect.innerHTML = '';
        cats.forEach(c => {
            catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
        document.getElementById('entry-subcategory').innerHTML = '';
    }
});

document.getElementById('entry-category').addEventListener('change', async function() {
    const catId = this.value;
    if (catId) {
        const response = await fetch(`/api/subcategories/${catId}`);
        const subs = await response.json();
        const subSelect = document.getElementById('entry-subcategory');
        subSelect.innerHTML = '';
        subs.forEach(s => {
            subSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
    }
});
</script>
{% endblock %}
